<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World Explorer Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background-color: #0f172a;
      color: #f1f5f9;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* üåê Navbar */
    nav {
      background: #1e293b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid #334155;
      z-index: 1000;
    }

    nav h1 {
      color: #38bdf8;
      font-size: 20px;
      margin: 0;
    }

    .nav-links a {
      color: #f1f5f9;
      text-decoration: none;
      margin-left: 20px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: #38bdf8;
    }

    #map {
      flex: 1;
      width: 100%;
    }

    .leaflet-popup-content-wrapper {
      background: #1e293b;
      color: #f1f5f9;
      border-radius: 10px;
      border: 1px solid #38bdf8;
    }

    .leaflet-popup-tip {
      background: #1e293b;
    }

    .flag {
      width: 70px;
      border-radius: 6px;
      display: block;
      margin-bottom: 5px;
    }

    .attr-btn {
      background: #38bdf8;
      border: none;
      color: #0f172a;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <!-- üß≠ Navbar -->
  <nav>
    <h1>Travel Snapshot üåç</h1>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="map.html">Map</a>
      <a href="favorites.html">Favorites</a>
      <a href="#" id="logoutBtn">Logout</a>
    </div>
  </nav>

  <!-- üó∫Ô∏è Map -->
  <div id="map"></div>

  <script>
    const BASE_URL = "https://sesd-project-7gqa.onrender.com";
    const token = localStorage.getItem("access_token");

    // üîê Logout handler
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("access_token");
      alert("Logged out successfully!");
      window.location.href = "login.html";
    });

    // üó∫Ô∏è Initialize map
    const map = L.map("map", {
      minZoom: 2,
      maxBounds: [
        [-85, -180],
        [85, 180],
      ],
      worldCopyJump: true,
    }).setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    let geojsonLayer;
    let attractionMarkers = [];

    // üéØ API Calls
    async function fetchCountryInfo(name) {
      const res = await fetch(`${BASE_URL}/location/${encodeURIComponent(name)}`);
      if (!res.ok) throw new Error("Country fetch failed");
      return await res.json();
    }

    async function fetchWeather(lat, lng) {
      const res = await fetch(`${BASE_URL}/weather?lat=${lat}&lng=${lng}`);
      if (!res.ok) throw new Error("Weather fetch failed");
      return await res.json();
    }

    async function fetchAttractions(country) {
      const res = await fetch(`${BASE_URL}/attractions/${encodeURIComponent(country)}`);
      if (!res.ok) throw new Error("Attractions fetch failed");
      return await res.json();
    }

    async function addFavorite(country, attraction = null) {
      if (!token) {
        alert("Please log in first!");
        return;
      }

      const payload = attraction
        ? { attraction_name: attraction.name, country_name: country }
        : { country_name: country };

      const res = await fetch(`${BASE_URL}/favorites/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      alert(data.message || "Added to favorites!");
    }

    // üìç Add markers for attractions
    function addAttractionMarker(attraction, countryName) {
      const marker = L.marker([attraction.lat, attraction.lng]).addTo(map);
      const popup = `
        <div>
          <b>${attraction.name}</b><br>
          ${attraction.description || ""}<br>
          <button class="attr-btn" onclick="addFavorite('${countryName}', ${JSON.stringify(attraction).replace(/"/g, '&quot;')})">
            ‚ù§Ô∏è Favorite
          </button>
        </div>
      `;
      marker.bindPopup(popup);
      attractionMarkers.push(marker);
    }

    function clearAttractionMarkers() {
      attractionMarkers.forEach(m => map.removeLayer(m));
      attractionMarkers = [];
    }

    // üåç Load world data
    fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
      .then(res => res.json())
      .then(data => {
        geojsonLayer = L.geoJson(data, {
          style: {
            color: "#38bdf8",
            weight: 1,
            fillOpacity: 0.2,
          },
          onEachFeature: (feature, layer) => {
            const countryName = feature.properties.name;
            layer.on({
              mouseover: e => e.target.setStyle({ fillOpacity: 0.5, color: "#facc15" }),
              mouseout: e => e.target.setStyle({ fillOpacity: 0.2, color: "#38bdf8" }),
              click: async e => {
                clearAttractionMarkers();
                map.fitBounds(layer.getBounds(), { padding: [20, 20] });

                try {
                  const info = await fetchCountryInfo(countryName);
                  const weather = await fetchWeather(info.latlng[0], info.latlng[1]);
                  const attractions = await fetchAttractions(countryName);

                  const popupLatLng = info.latlng?.length
                    ? [info.latlng[0], info.latlng[1]]
                    : e.latlng;

                  const content = `
                    <div>
                      <img src="${info.flag}" class="flag" />
                      <b>${info.name}</b><br>
                      Capital: ${info.capital}<br>
                      Currency: ${info.currency}<br>
                      Temp: ${weather?.weather?.temperature ?? "N/A"}¬∞C<br>
                      <button class="attr-btn" onclick="addFavorite('${info.name}')">‚ù§Ô∏è Favorite Country</button>
                    </div>
                  `;
                  L.popup({ closeOnClick: true })
                    .setLatLng(popupLatLng)
                    .setContent(content)
                    .openOn(map);

                  if (attractions?.attractions?.length) {
                    attractions.attractions.forEach(a => addAttractionMarker(a, info.name));
                  }
                } catch (err) {
                  console.error(err);
                  alert("Error loading data for " + countryName);
                }
              },
            });
          },
        }).addTo(map);
      })
      .catch(err => console.error("GeoJSON load failed", err));
  </script>
</body>
</html>
